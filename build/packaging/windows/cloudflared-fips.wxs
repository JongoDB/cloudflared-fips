<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX v4+ manifest for cloudflared-fips Windows MSI installer.
  Build: wix build -o cloudflared-fips.msi cloudflared-fips.wxs
  Requires: WiX Toolset v4+ (https://wixtoolset.org)
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package
    Name="cloudflared-fips"
    Manufacturer="cloudflared-fips project"
    Version="$(var.Version)"
    UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of cloudflared-fips is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <!-- Install directory -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="cloudflared-fips">
        <Component Id="MainBinary" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
          <File Id="CloudflaredExe"
                Source="$(var.BinaryPath)\cloudflared.exe"
                KeyPath="yes" />
        </Component>

        <Component Id="SelfTestBinary" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234">
          <File Id="SelfTestExe"
                Source="$(var.BinaryPath)\selftest.exe" />
        </Component>

        <Component Id="BuildManifest" Guid="D4E5F6A7-B8C9-0123-DEF0-456789012345">
          <File Id="BuildManifestJson"
                Source="$(var.BinaryPath)\build-manifest.json" />
        </Component>

        <Component Id="SampleConfig" Guid="E5F6A7B8-C9D0-1234-EF01-567890123456">
          <File Id="SampleConfigYaml"
                Source="$(var.BinaryPath)\cloudflared-fips.yaml" />
        </Component>

        <!-- Add to PATH -->
        <Component Id="PathEntry" Guid="F6A7B8C9-D0E1-2345-F012-678901234567">
          <Environment Id="PATH"
                       Name="PATH"
                       Value="[INSTALLFOLDER]"
                       Permanent="no"
                       Part="last"
                       Action="set"
                       System="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Feature tree -->
    <Feature Id="ProductFeature" Title="cloudflared-fips" Level="1">
      <ComponentRef Id="MainBinary" />
      <ComponentRef Id="SelfTestBinary" />
      <ComponentRef Id="BuildManifest" />
      <ComponentRef Id="SampleConfig" />
      <ComponentRef Id="PathEntry" />
    </Feature>

    <!-- Run self-test after install -->
    <CustomAction Id="RunSelfTest"
                  FileRef="SelfTestExe"
                  ExeCommand=""
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="RunSelfTest" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>
  </Package>
</Wix>
