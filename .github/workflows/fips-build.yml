name: FIPS Build Pipeline

on:
  push:
    tags: ['v*']
  pull_request:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  GO_VERSION: '1.24.0'

jobs:
  # ── Linux builds: RHEL UBI 9 container with GOEXPERIMENT=boringcrypto ──
  build-linux:
    name: Build linux/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    container:
      image: registry.access.redhat.com/ubi9/ubi:latest
    strategy:
      fail-fast: false
      matrix:
        goarch: [amd64, arm64]
        include:
          - goarch: amd64
            package: rpm,deb,container
            cc: gcc
          - goarch: arm64
            package: rpm,deb,container
            cc: aarch64-linux-gnu-gcc

    steps:
      - name: Checkout cloudflared-fips
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y gcc gcc-c++ make git openssl-devel curl jq
          dnf clean all

      - name: Install cross-compiler (arm64)
        if: matrix.goarch == 'arm64'
        run: |
          dnf install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Install Go ${{ env.GO_VERSION }}
        run: |
          curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" \
            | tar -C /usr/local -xzf -
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Clone upstream cloudflared
        run: |
          git clone --depth 1 https://github.com/cloudflare/cloudflared.git upstream-cloudflared
          echo "UPSTREAM_VERSION=$(git -C upstream-cloudflared describe --tags 2>/dev/null || echo 'main')" >> $GITHUB_ENV
          echo "UPSTREAM_COMMIT=$(git -C upstream-cloudflared rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Dependency crypto audit
        working-directory: upstream-cloudflared
        run: |
          echo "=== Crypto Dependency Audit ==="
          /usr/local/go/bin/go list -deps ./cmd/cloudflared 2>/dev/null | grep -i crypto || true
          echo "GOEXPERIMENT=boringcrypto will replace all crypto/* with BoringCrypto"

      - name: Build cloudflared with FIPS crypto
        env:
          GOEXPERIMENT: boringcrypto
          CGO_ENABLED: '1'
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          CC: ${{ matrix.cc }}
        working-directory: upstream-cloudflared
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          /usr/local/go/bin/go build -v \
            -ldflags "-X main.Version=${VERSION} \
                      -X main.BuildDate=${BUILD_DATE} \
                      -X main.GitCommit=${{ github.sha }}" \
            -o /tmp/cloudflared \
            ./cmd/cloudflared

      - name: Run FIPS self-test (amd64 only)
        if: matrix.goarch == 'amd64'
        env:
          GOEXPERIMENT: boringcrypto
          CGO_ENABLED: '1'
        run: |
          /usr/local/go/bin/go build -o /tmp/selftest ./cmd/selftest
          /tmp/selftest

      - name: Verify BoringCrypto symbols
        if: matrix.goarch == 'amd64'
        run: |
          BORING_COUNT=$(/usr/local/go/bin/go tool nm /tmp/cloudflared 2>/dev/null \
            | grep -c '_Cfunc__goboringcrypto_' || true)
          echo "BoringCrypto symbols found: ${BORING_COUNT}"
          if [ "${BORING_COUNT}" -lt 1 ]; then
            echo "::error::BoringCrypto symbols not found in binary"
            exit 1
          fi

      - name: Install SBOM tools
        run: |
          /usr/local/go/bin/go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest 2>/dev/null || true
          echo "$(/usr/local/go/bin/go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Generate SBOM
        run: |
          bash scripts/generate-sbom.sh \
            upstream-cloudflared \
            /tmp \
            "${UPSTREAM_VERSION}-fips"

      - name: Build self-test binary
        if: matrix.goarch == 'amd64'
        env:
          GOEXPERIMENT: boringcrypto
          CGO_ENABLED: '1'
        run: |
          /usr/local/go/bin/go build -o /tmp/selftest ./cmd/selftest

      - name: Package — RPM
        if: contains(matrix.package, 'rpm')
        run: |
          dnf install -y rpm-build
          mkdir -p /root/rpmbuild/{SOURCES,SPECS,BUILD,RPMS,SRPMS}
          cp /tmp/cloudflared /root/rpmbuild/SOURCES/
          cp /tmp/selftest /root/rpmbuild/SOURCES/ 2>/dev/null || true
          cp configs/cloudflared-fips.yaml /root/rpmbuild/SOURCES/ 2>/dev/null || true
          cp /tmp/build-manifest.json /root/rpmbuild/SOURCES/ 2>/dev/null || true
          VERSION="${UPSTREAM_VERSION}-fips" rpmbuild -bb build/packaging/rpm/cloudflared-fips.spec
          cp /root/rpmbuild/RPMS/*/*.rpm /tmp/ 2>/dev/null || true

      - name: Package — DEB
        if: contains(matrix.package, 'deb')
        run: |
          # dpkg-deb may not be on RHEL; install if missing
          dnf install -y dpkg 2>/dev/null || true
          DEB_ARCH=${{ matrix.goarch }}
          if [ "$DEB_ARCH" = "amd64" ]; then DEB_ARCH="amd64"; fi
          if [ "$DEB_ARCH" = "arm64" ]; then DEB_ARCH="arm64"; fi
          bash build/packaging/deb/build-deb.sh \
            "${UPSTREAM_VERSION}-fips" \
            "$DEB_ARCH" \
            /tmp \
            /tmp

      - name: Package — Container (OCI)
        if: contains(matrix.package, 'container')
        run: |
          # Build OCI image using the pre-compiled binary
          dnf install -y podman 2>/dev/null || true
          if command -v podman >/dev/null 2>&1; then
            podman build -f build/Dockerfile.fips \
              --build-arg VERSION="${UPSTREAM_VERSION}-fips" \
              --build-arg GIT_COMMIT="${{ github.sha }}" \
              -t "cloudflared-fips:${UPSTREAM_VERSION}-fips" . || echo "Container build requires podman/docker"
          else
            echo "Container packaging skipped — podman/docker not available"
          fi

      - name: Generate build manifest
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          BINARY_SHA256=""
          SBOM_SHA256=""
          if [ -f /tmp/cloudflared ]; then
            BINARY_SHA256=$(sha256sum /tmp/cloudflared | awk '{print $1}')
          fi
          if [ -f /tmp/sbom.spdx.json ]; then
            SBOM_SHA256=$(sha256sum /tmp/sbom.spdx.json | awk '{print $1}')
          fi

          cat > /tmp/build-manifest.json <<EOJSON
          {
            "version": "${VERSION}",
            "commit": "${{ github.sha }}",
            "build_time": "${BUILD_DATE}",
            "cloudflared_upstream_version": "${UPSTREAM_VERSION}",
            "cloudflared_upstream_commit": "${UPSTREAM_COMMIT}",
            "crypto_engine": "boringcrypto",
            "boringssl_version": "fips-20220613",
            "fips_certificates": [
              {
                "module": "BoringSSL",
                "certificate": "#3678",
                "algorithms": ["AES-GCM-128","AES-GCM-256","SHA-256","SHA-384","HMAC-SHA-256","ECDSA-P256","RSA-2048","ECDH-P256"]
              },
              {
                "module": "RHEL OpenSSL",
                "certificate": "#4349",
                "algorithms": ["AES-GCM-128","AES-GCM-256","SHA-256","SHA-384","RSA-2048","ECDSA-P256","ECDH-P256"]
              }
            ],
            "target_platform": "linux/${{ matrix.goarch }}",
            "package_format": "${{ matrix.package }}",
            "sbom_sha256": "${SBOM_SHA256}",
            "binary_sha256": "${BINARY_SHA256}"
          }
          EOJSON

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-fips-linux-${{ matrix.goarch }}
          path: |
            /tmp/cloudflared
            /tmp/selftest
            /tmp/build-manifest.json
            /tmp/sbom.*.json
            /tmp/cloudflared-fips*.rpm
            /tmp/cloudflared-fips*.deb
          if-no-files-found: error

  # ── macOS builds: native runner, Go native FIPS 140-3 (GODEBUG=fips140=on) ──
  build-darwin:
    name: Build darwin/${{ matrix.goarch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - goarch: amd64
            runner: macos-13
          - goarch: arm64
            runner: macos-14

    steps:
      - name: Checkout cloudflared-fips
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Clone upstream cloudflared
        run: |
          git clone --depth 1 https://github.com/cloudflare/cloudflared.git upstream-cloudflared
          echo "UPSTREAM_VERSION=$(git -C upstream-cloudflared describe --tags 2>/dev/null || echo 'main')" >> $GITHUB_ENV
          echo "UPSTREAM_COMMIT=$(git -C upstream-cloudflared rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build cloudflared with Go native FIPS
        env:
          # GOEXPERIMENT=boringcrypto is Linux-only.
          # Go 1.24+ native FIPS 140-3 module (CAVP A6650, CMVP pending).
          # When CMVP validation completes, this becomes the standard macOS path.
          GODEBUG: fips140=on
          CGO_ENABLED: '0'
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
        working-directory: upstream-cloudflared
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          go build -v \
            -ldflags "-X main.Version=${VERSION} \
                      -X main.BuildDate=${BUILD_DATE} \
                      -X main.GitCommit=${{ github.sha }}" \
            -o /tmp/cloudflared \
            ./cmd/cloudflared

      - name: Generate build manifest
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          BINARY_SHA256=$(shasum -a 256 /tmp/cloudflared | awk '{print $1}')

          cat > /tmp/build-manifest.json <<EOJSON
          {
            "version": "${VERSION}",
            "commit": "${{ github.sha }}",
            "build_time": "${BUILD_DATE}",
            "cloudflared_upstream_version": "${UPSTREAM_VERSION}",
            "cloudflared_upstream_commit": "${UPSTREAM_COMMIT}",
            "crypto_engine": "go-fips140-native",
            "boringssl_version": "n/a",
            "fips_certificates": [
              {
                "module": "Go Cryptographic Module",
                "certificate": "CAVP A6650 (CMVP pending)",
                "algorithms": ["AES-GCM-128","AES-GCM-256","SHA-256","SHA-384","HMAC-SHA-256","ECDSA-P256","RSA-2048","ECDH-P256"]
              }
            ],
            "target_platform": "darwin/${{ matrix.goarch }}",
            "package_format": "binary",
            "sbom_sha256": "",
            "binary_sha256": "${BINARY_SHA256}"
          }
          EOJSON

      - name: Package — macOS .pkg
        run: |
          bash build/packaging/macos/build-pkg.sh \
            "${UPSTREAM_VERSION}-fips" \
            /tmp \
            /tmp

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-fips-darwin-${{ matrix.goarch }}
          path: |
            /tmp/cloudflared
            /tmp/build-manifest.json
            /tmp/cloudflared-fips-*.pkg
          if-no-files-found: error

  # ── Windows builds: native runner, Go native FIPS 140-3 (GODEBUG=fips140=on) ──
  build-windows:
    name: Build windows/${{ matrix.goarch }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        goarch: [amd64, arm64]

    steps:
      - name: Checkout cloudflared-fips
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Clone upstream cloudflared
        shell: bash
        run: |
          git clone --depth 1 https://github.com/cloudflare/cloudflared.git upstream-cloudflared
          echo "UPSTREAM_VERSION=$(git -C upstream-cloudflared describe --tags 2>/dev/null || echo 'main')" >> $GITHUB_ENV
          echo "UPSTREAM_COMMIT=$(git -C upstream-cloudflared rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build cloudflared with Go native FIPS
        env:
          # GOEXPERIMENT=boringcrypto is Linux-only.
          # Go 1.24+ native FIPS 140-3 module (CAVP A6650, CMVP pending).
          # Alternative: Microsoft Build of Go with GOEXPERIMENT=systemcrypto
          # uses Windows CNG (CMVP validated) — requires MSFT Go fork.
          GODEBUG: fips140=on
          CGO_ENABLED: '0'
          GOOS: windows
          GOARCH: ${{ matrix.goarch }}
        working-directory: upstream-cloudflared
        shell: bash
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          go build -v \
            -ldflags "-X main.Version=${VERSION} \
                      -X main.BuildDate=${BUILD_DATE} \
                      -X main.GitCommit=${{ github.sha }}" \
            -o "${RUNNER_TEMP}/cloudflared.exe" \
            ./cmd/cloudflared

      - name: Generate build manifest
        shell: bash
        run: |
          VERSION="${UPSTREAM_VERSION}-fips"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          BINARY_SHA256=$(sha256sum "${RUNNER_TEMP}/cloudflared.exe" | awk '{print $1}')

          cat > "${RUNNER_TEMP}/build-manifest.json" <<EOJSON
          {
            "version": "${VERSION}",
            "commit": "${{ github.sha }}",
            "build_time": "${BUILD_DATE}",
            "cloudflared_upstream_version": "${UPSTREAM_VERSION}",
            "cloudflared_upstream_commit": "${UPSTREAM_COMMIT}",
            "crypto_engine": "go-fips140-native",
            "boringssl_version": "n/a",
            "fips_certificates": [
              {
                "module": "Go Cryptographic Module",
                "certificate": "CAVP A6650 (CMVP pending)",
                "algorithms": ["AES-GCM-128","AES-GCM-256","SHA-256","SHA-384","HMAC-SHA-256","ECDSA-P256","RSA-2048","ECDH-P256"]
              }
            ],
            "target_platform": "windows/${{ matrix.goarch }}",
            "package_format": "${{ matrix.goarch == 'amd64' && 'exe,msi' || 'exe' }}",
            "sbom_sha256": "",
            "binary_sha256": "${BINARY_SHA256}"
          }
          EOJSON

      - name: Package — MSI (amd64 only)
        if: matrix.goarch == 'amd64'
        shell: pwsh
        run: |
          # WiX v4 is pre-installed on windows-latest runners
          # If not available, install: dotnet tool install --global wix
          $version = "${{ env.UPSTREAM_VERSION }}-fips" -replace '[^0-9.]', ''
          if (-not $version) { $version = "1.0.0" }
          try {
            wix build `
              -d Version="$version" `
              -d BinaryPath="${{ runner.temp }}" `
              -o "${{ runner.temp }}/cloudflared-fips.msi" `
              build/packaging/windows/cloudflared-fips.wxs
          } catch {
            Write-Warning "MSI build failed: $_. WiX may not be available."
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-fips-windows-${{ matrix.goarch }}
          path: |
            ${{ runner.temp }}/cloudflared.exe
            ${{ runner.temp }}/build-manifest.json
            ${{ runner.temp }}/cloudflared-fips.msi
          if-no-files-found: error
